<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jade Mountain Academy</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#064e3b">
    <link rel="apple-touch-icon" href="https://static.wikia.nocookie.net/wingsoffire/images/5/53/Tsunami_Graphic_Novel.png">
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkphZGUgTW91bnRhaW4gQWNhZGVteSIsCiAgInNob3J0X25hbWUiOiAiSk1BIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwNjRlM2IiLAogICJ0aGVtZV9jb2xvciI6ICIjMDY0ZTNiIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9zdGF0aWMud2lraWEubm9jb29raWUubmV0L3dpbmdzb2ZmaXJlL2ltYWdlcy81LzUzL1RzdW5hbWlfR3JhcGhpY19Ob3ZlbC5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src='https://cdn.jotfor.ms/s/umd/00294e3ed83/for-form-embed-handler.js'></script>
    
    <style>
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        .animate-pulse-ring { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .target-appear { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        html, body {
            -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; overscroll-behavior-y: none;
        }
        input { -webkit-user-select: text; user-select: text; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-950 via-stone-900 to-emerald-900 text-stone-100 h-screen overflow-hidden font-sans">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Scroll: (p) => <IconWrapper {...p}><path d="M8 2h2v20H8z"/><path d="M14 2h2v20h-2z"/><path d="M8 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2"/></IconWrapper>,
            Users: (p) => <IconWrapper {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
            MessageCircle: (p) => <IconWrapper {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconWrapper>,
            Flame: (p) => <IconWrapper {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.4-1.1 1-2.2 2-3 .5.9.9 1.8.9 2.8z"/></IconWrapper>,
            Droplets: (p) => <IconWrapper {...p}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></IconWrapper>,
            Wind: (p) => <IconWrapper {...p}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>,
            Mountain: (p) => <IconWrapper {...p}><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></IconWrapper>,
            Snowflake: (p) => <IconWrapper {...p}><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></IconWrapper>,
            Sun: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></IconWrapper>,
            Moon: (p) => <IconWrapper {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></IconWrapper>,
            BookOpen: (p) => <IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>,
            Utensils: (p) => <IconWrapper {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconWrapper>,
            Home: (p) => <IconWrapper {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>,
            Menu: (p) => <IconWrapper {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>,
            Send: (p) => <IconWrapper {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconWrapper>,
            Sparkles: (p) => <IconWrapper {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M3 7v2"/><path d="M7 9H3"/></IconWrapper>,
            Video: (p) => <IconWrapper {...p}><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></IconWrapper>,
            Mic: (p) => <IconWrapper {...p}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></IconWrapper>,
            MicOff: (p) => <IconWrapper {...p}><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></IconWrapper>,
            PhoneOff: (p) => <IconWrapper {...p}><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/><line x1="23" y1="1" x2="1" y2="23"/></IconWrapper>,
            GraduationCap: (p) => <IconWrapper {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconWrapper>,
            History: (p) => <IconWrapper {...p}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/></IconWrapper>,
            LogOut: (p) => <IconWrapper {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconWrapper>,
            PhoneCall: (p) => <IconWrapper {...p}><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconWrapper>,
            Glasses: (p) => <IconWrapper {...p}><circle cx="6" cy="12" r="4"/><circle cx="18" cy="12" r="4"/><line x1="10" y1="12" x2="14" y2="12"/></IconWrapper>,
            Crown: (p) => <IconWrapper {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></IconWrapper>,
            Zap: (p) => <IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>,
            Flower: (p) => <IconWrapper {...p}><path d="M12 2a3 3 0 0 0-3 3c0 1.66 1.34 3 3 3s3-1.34 3-3a3 3 0 0 0-3-3z"/><path d="M19 9a3 3 0 0 0-3-3c-1.66 0-3 1.34-3 3s1.34 3 3 3a3 3 0 0 0 3-3z"/><path d="M12 16a3 3 0 0 0-3-3c0-1.66 1.34-3 3-3s3 1.34 3 3a3 3 0 0 0-3 3z"/><path d="M5 9a3 3 0 0 0-3-3c-1.66 0-3 1.34-3 3s1.34 3 3 3a3 3 0 0 0 3-3z"/><circle cx="12" cy="9" r="2"/><path d="M12 18v4"/><path d="M12 20c-2 0-3-1-3-3"/></IconWrapper>,
            Swords: (p) => <IconWrapper {...p}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" y1="14" x2="9" y2="18"/><line x1="7" y1="17" x2="4" y2="20"/><line x1="2" y1="19" x2="4" y2="21"/></IconWrapper>,
            Palette: (p) => <IconWrapper {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconWrapper>,
            Crosshair: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconWrapper>,
            Ear: (p) => <IconWrapper {...p}><path d="M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 10a3.5 3.5 0 1 1-7 0"/><path d="M15 8.5a2.5 2.5 0 0 0-5 0v1a2 2 0 1 0 4 0v-1z"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>,
            Shield: (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>
        };

        const TRIBES = [
            { id: 'mud', name: 'MudWing', color: 'bg-amber-800', textColor: 'text-amber-900', icon: Icons.Mountain, description: 'Strong, loyal, and love food.' },
            { id: 'sea', name: 'SeaWing', color: 'bg-cyan-600', textColor: 'text-cyan-800', icon: Icons.Droplets, description: 'Aquatic, can breathe underwater.' },
            { id: 'sky', name: 'SkyWing', color: 'bg-red-600', textColor: 'text-red-800', icon: Icons.Wind, description: 'Fast fliers and powerful fighters.' },
            { id: 'ice', name: 'IceWing', color: 'bg-slate-200', textColor: 'text-slate-600', icon: Icons.Snowflake, description: 'Can withstand subzero temps and exhale frostbreath.' },
            { id: 'rain', name: 'RainWing', color: 'bg-emerald-500', textColor: 'text-emerald-800', icon: Icons.Sparkles, description: 'Camouflage scales and magical venom.' },
            { id: 'sand', name: 'SandWing', color: 'bg-yellow-400', textColor: 'text-yellow-800', icon: Icons.Sun, description: 'Poisonous tail barb and fire breath.' },
            { id: 'night', name: 'NightWing', color: 'bg-indigo-900', textColor: 'text-indigo-200', icon: Icons.Moon, description: 'Mind readers and prophets (sometimes).' },
        ];

        const ACCESSORIES = [
            { id: 'none', name: 'None', icon: null },
            { id: 'glasses', name: 'Glasses', icon: Icons.Glasses },
            { id: 'crown', name: 'Crown', icon: Icons.Crown },
            { id: 'scar', name: 'Scar', icon: Icons.Zap },
            { id: 'flower', name: 'Flower', icon: Icons.Flower }
        ];

        const EYE_COLORS = [
            { id: 'black', name: 'Black', hex: '#000000' },
            { id: 'blue', name: 'Blue', hex: '#3b82f6' },
            { id: 'green', name: 'Green', hex: '#22c55e' },
            { id: 'amber', name: 'Amber', hex: '#f59e0b' },
            { id: 'purple', name: 'Purple', hex: '#a855f7' },
            { id: 'red', name: 'Red', hex: '#ef4444' }
        ];

        const LOCATIONS = [
            { id: 'great_hall', name: 'Great Hall', icon: Icons.Home, description: 'The main gathering place. Sunlight filters through leaves far above.', bg: 'bg-stone-100' },
            { id: 'history_cave', name: 'History Cave', icon: Icons.History, description: 'Smells of old scrolls and damp rock. Webs is usually here.', bg: 'bg-stone-200' },
            { id: 'library', name: 'The Library', icon: Icons.BookOpen, description: 'Scrolls stacked to the ceiling. Starflight is sorting them.', bg: 'bg-amber-50' },
            { id: 'arena', name: 'The Arena', icon: Icons.Swords, description: 'Practice your fighting skills with Tsunami. Watch out!', bg: 'bg-red-50' },
            { id: 'art_cave', name: 'Art Cave', icon: Icons.Palette, description: 'A colorful cave filled with paints, berries, and clay.', bg: 'bg-pink-50' },
            { id: 'prey_center', name: 'Prey Center', icon: Icons.Utensils, description: 'Roasting fires and the smell of delicious cows.', bg: 'bg-orange-50' },
            { id: 'underground_lake', name: 'Underground Lake', icon: Icons.Droplets, description: 'A cool, dark lake glowing with phosphorescent moss.', bg: 'bg-blue-900 text-white' },
        ];

        const NPCS = [
            { id: 'clay', role: 'student', name: 'Clay', tribe: 'MudWing', avatarColor: 'bg-amber-700', personality: ['Hungry', 'Protective', 'Friendly'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/0/02/Clay_GN_Infobox.png/revision/latest?cb=20210617155608', agentUrl: "https://agent.jotform.com/019bd3c38eaf74f1a5d9d739df35de42390e?embedMode=iframe&background=1&shadow=1" },
            { id: 'tsunami', role: 'student', name: 'Tsunami', tribe: 'SeaWing', avatarColor: 'bg-cyan-600', personality: ['Fierce', 'Princess', 'Leader'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/5/53/Tsunami_Graphic_Novel.png/revision/latest/scale-to-width-down/350?cb=20210217034444', agentUrl: "https://agent.jotform.com/019bd39c7f5472bc968724f259bfdddc2c70?embedMode=iframe&background=1&shadow=1" },
            { id: 'glory', role: 'student', name: 'Glory', tribe: 'RainWing', avatarColor: 'bg-emerald-500', personality: ['Sarcastic', 'Regal', 'Sharp'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/f/f0/Glory_GN_Infobox.png/revision/latest?cb=20210617155829', agentUrl: null },
            { id: 'starflight', role: 'student', name: 'Starflight', tribe: 'NightWing', avatarColor: 'bg-indigo-900', personality: ['Nervous', 'Smart', 'Lecture-y'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/5/5d/Starflight_GN_Infobox.png/revision/latest?cb=20210617160012', agentUrl: null },
            { id: 'sunny', role: 'student', name: 'Sunny', tribe: 'SandWing', avatarColor: 'bg-yellow-300', personality: ['Optimistic', 'Happy', 'Peacemaker'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/1/1b/Sunny_GN_Infobox.png/revision/latest?cb=20210617160205', agentUrl: null },
            { id: 'webs', role: 'teacher', name: 'Webs', tribe: 'SeaWing', avatarColor: 'bg-cyan-800', personality: ['Anxious', 'Teacher', 'Historian'], avatarImage: 'https://static.wikia.nocookie.net/wingsoffire/images/b/b3/Webs_Graphic_Novel.png/revision/latest?cb=20220205063832', agentUrl: null },
        ];

        const QUIZ_QUESTIONS = [
            { question: "Who was the first queen of the SandWings?", options: ["Oasis", "Scorpion", "Burn"], answer: "Oasis" },
            { question: "What event started the Great War?", options: ["The stealing of the egg", "The death of Queen Oasis", "The scorching"], answer: "The death of Queen Oasis" },
            { question: "Which tribe can breathe underwater?", options: ["MudWings", "SeaWings", "RainWings"], answer: "SeaWings" },
            { question: "Who is the librarian at Jade Mountain?", options: ["Tsunami", "Starflight", "Webs"], answer: "Starflight" },
            { question: "What is a Scavenger?", options: ["A type of bird", "A human", "A lost dragonet"], answer: "A human" }
        ];

        const SCROLL_TITLES = [
            { id: 1, title: "The Scorching: A History", category: "History" },
            { id: 2, title: "Venomous Plants of the Rainforest", category: "Science" },
            { id: 3, title: "Battle Tactics of the SkyWings", category: "War" },
            { id: 4, title: "A Guide to Scavengers", category: "Nature" },
        ];

        const getResponse = (npcId, userMessage, location) => {
            const msg = userMessage.toLowerCase();
            const responses = {
                clay: ["Is it lunch time yet? I'm starving!", "Hey! Glad you're in our winglet.", "Do you think they're serving cow today?", "If anyone bothers you, just let me know."],
                tsunami: ["I'm not bossy, I'm the leader!", "Three moons, let's go do something heroic!", "If you need saving, just yell my name.", "I challenge you to a race!"],
                glory: ["Don't stare at my scales.", "I don't need training, I have magical death spit.", "Try to keep up, newbie.", "Ugh, Tsunami is being loud."],
                starflight: ["Actually, according to scroll 42...", "Have you read the guide?", "Please don't set anything on fire.", "I'm just trying to study..."],
                sunny: ["Hi!! Your scales are so shiny!", "Isn't Jade Mountain amazing?", "Everything is going to be great!", "Let's explore!"],
                webs: ["Class, settle down!", "History is important.", "Do not run in the hallways!", "Open your scrolls."]
            };
            const list = responses[npcId];
            return list ? list[Math.floor(Math.random() * list.length)] : "Hmm...";
        };

        const DragonAvatar = ({ tribe, custom, size = 'md' }) => {
            const sizeClasses = { sm: 'w-8 h-8', md: 'w-12 h-12', lg: 'w-32 h-32' };
            const iconSizes = { sm: 14, md: 24, lg: 64 };
            const eyeColor = custom?.eyeColor || '#000000';
            const AccessoryIcon = ACCESSORIES.find(a => a.id === custom?.accessory)?.icon;
            return (
                <div className={`${sizeClasses[size]} rounded-full ${tribe.color} relative flex items-center justify-center text-white shadow-md border-2 border-white/20 overflow-hidden`}>
                    <tribe.icon size={iconSizes[size]} className="opacity-90" />
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div className="flex gap-[8px] mt-[-4px]"> 
                             {size !== 'sm' && (
                                <>
                                 <div style={{ backgroundColor: eyeColor }} className={`rounded-full ${size === 'lg' ? 'w-3 h-3' : 'w-1 h-1'}`}></div>
                                 <div style={{ backgroundColor: eyeColor }} className={`rounded-full ${size === 'lg' ? 'w-3 h-3' : 'w-1 h-1'}`}></div>
                                </>
                             )}
                        </div>
                    </div>
                    {AccessoryIcon && <div className="absolute inset-0 flex items-center justify-center text-white/90 drop-shadow-md"><AccessoryIcon size={size === 'lg' ? 50 : 20} strokeWidth={2.5} /></div>}
                </div>
            );
        };

        const BattleGame = ({ onEnd }) => {
            const [score, setScore] = useState(0);
            const [target, setTarget] = useState({ x: 50, y: 50 });
            const [timeLeft, setTimeLeft] = useState(15);
            useEffect(() => {
                const timer = setInterval(() => {
                    setTimeLeft(t => { if (t <= 1) { clearInterval(timer); onEnd(score); return 0; } return t - 1; });
                }, 1000);
                return () => clearInterval(timer);
            }, [score, onEnd]);
            const hitTarget = () => { setScore(s => s + 100); setTarget({ x: Math.random() * 80 + 10, y: Math.random() * 80 + 10 }); };
            return (
                <div className="relative w-full h-64 bg-stone-800 rounded-xl overflow-hidden border-2 border-red-900 shadow-inner">
                    <div className="absolute top-2 left-2 text-white font-mono bg-black/50 px-2 rounded">Time: {timeLeft}s</div>
                    <div className="absolute top-2 right-2 text-white font-mono bg-black/50 px-2 rounded">Score: {score}</div>
                    <button onClick={hitTarget} style={{ top: `${target.y}%`, left: `${target.x}%` }} className="absolute w-12 h-12 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full border-4 border-white flex items-center justify-center shadow-lg active:scale-90 transition-transform cursor-crosshair"><Icons.Shield size={24} className="text-white" /></button>
                </div>
            );
        };

        function JadeMountainAcademy() {
            const [user, setUser] = useState(null);
            const [currentLocation, setCurrentLocation] = useState('great_hall');
            const [messages, setMessages] = useState([{ id: 0, sender: 'Sunny', text: "Welcome to Jade Mountain Academy!!", type: 'npc' }]);
            const [inputText, setInputText] = useState('');
            const [activeTab, setActiveTab] = useState('chat');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeCall, setActiveCall] = useState(null);
            const [lessonActive, setLessonActive] = useState(false);
            const [battleActive, setBattleActive] = useState(false);
            const [libraryActive, setLibraryActive] = useState(false);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [isListening, setIsListening] = useState(false);
            const isListeningRef = useRef(false);
            const chatEndRef = useRef(null);
            const recognitionRef = useRef(null);

            useEffect(() => {
                const savedData = localStorage.getItem('jma_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.user) { parsed.user.tribe = TRIBES.find(t => t.id === parsed.user.tribe.id); setUser(parsed.user); }
                    if (parsed.location) setCurrentLocation(parsed.location);
                }
            }, []);

            useEffect(() => { if (user) localStorage.setItem('jma_data', JSON.stringify({ user, location: currentLocation })); }, [user, currentLocation]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSendMessage = useCallback((e, overrideText = null) => {
                if (e) e.preventDefault();
                const text = overrideText || inputText;
                if (!text || !text.trim()) return;
                setMessages(prev => [...prev, { id: Date.now(), sender: 'You', text: text, type: 'user' }]);
                setInputText('');
                setTimeout(() => {
                    setMessages(prevMsgs => {
                         const randomFriend = NPCS[Math.floor(Math.random() * NPCS.length)];
                         const responseText = getResponse(randomFriend.id, text, 'chat');
                         return [...prevMsgs, { id: Date.now() + 1, sender: randomFriend.name, text: responseText, type: 'npc', avatarColor: randomFriend.avatarColor, avatarImage: randomFriend.avatarImage }];
                    });
                }, 1500);
            }, [inputText]);

            const triggerWingletChat = () => {
                const scenarios = [
                    [
                        { sender: 'Clay', text: "I'm so hungry. Tsunami, did you eat the rest of the hippos?" },
                        { sender: 'Tsunami', text: "No! I've been busy saving the world, unlike some dragons who just think about food." },
                        { sender: 'Clay', text: "Saving the world takes energy! I need a snack." },
                        { sender: 'Tsunami', text: "Fine. Let's go to the prey center. But I'm flying point." }
                    ],
                    [
                        { sender: 'Glory', text: "Can we please go one day without Tsunami challenging someone to a fight?" },
                        { sender: 'Tsunami', text: "It's called training, Glory! Maybe if you practiced, you wouldn't be so grumpy." },
                        { sender: 'Glory', text: "I'm a RainWing. My 'practice' involves napping and looking fabulous. Also, magical death spit." },
                        { sender: 'Clay', text: "Did someone say spit? I hope it's not on the cows." }
                    ],
                    [
                        { sender: 'Starflight', text: "The architectural integrity of these caves is actually fascinating..." },
                        { sender: 'Sunny', text: "Starflight, look! I found a glow-worm that looks like a little star!" },
                        { sender: 'Starflight', text: "Fascinating. Though technically, Arachnocampa luminosa is a fly larva, not a star." },
                        { sender: 'Sunny', text: "It's still pretty! Don't be a scroll-worm, Starflight!" }
                    ],
                    [
                        { sender: 'Tsunami', text: "Webs is late for history. Again. Should I go wake him up with a roar?" },
                        { sender: 'Starflight', text: "Actually, he's in the library. He's nervous about the lesson on the Scorching." },
                        { sender: 'Glory', text: "Webs is nervous about his own shadow. I'll go tell him class is cancelled." },
                        { sender: 'Sunny', text: "No! I'll go give him a hug. Hugs make history better!" }
                    ],
                    [
                        { sender: 'Clay', text: "I think I smell roasting pork near the Great Hall." },
                        { sender: 'Glory', text: "Clay, that's just Tsunami's ego burning after I beat her at camouflage hide-and-seek." },
                        { sender: 'Tsunami', text: "I wasn't looking! I was... inspecting the moss!" },
                        { sender: 'Clay', text: "Moss doesn't smell like pork. I'm going to investigate." }
                    ],
                    [
                        { sender: 'Starflight', text: "Has anyone seen the scroll on NightWing prophecies? It's missing from the restricted section." },
                        { sender: 'Sunny', text: "I saw a scavenger playing with a piece of paper earlier!" },
                        { sender: 'Starflight', text: "A scavenger?! With a restricted scroll?! This is a disaster!" },
                        { sender: 'Tsunami', text: "Relax, Starflight. I'll go get it. Scavengers are basically just tiny, hairless snacks anyway." }
                    ],
                    [
                        { sender: 'Glory', text: "Your scales are turning bright pink, Sunny. What are you thinking about?" },
                        { sender: 'Sunny', text: "I'm thinking about the Summer Festival! Everyone will be together!" },
                        { sender: 'Glory', text: "Great. More noise, more dragons, and Tsunami probably trying to start a war with the snacks." },
                        { sender: 'Clay', text: "I'll defend the snacks! With my teeth!" }
                    ]
                ];

                const convo = scenarios[Math.floor(Math.random() * scenarios.length)];
                setMessages(prev => [...prev, { id: Date.now(), sender: 'System', text: "Listening in on Winglet conversation...", type: 'system' }]);
                convo.forEach((line, i) => {
                    setTimeout(() => {
                        const npc = NPCS.find(n => n.name === line.sender);
                        setMessages(prev => [...prev, { id: Date.now(), sender: npc.name, text: line.text, type: 'npc', avatarColor: npc.avatarColor, avatarImage: npc.avatarImage }]);
                    }, (i + 1) * 2000);
                });
            };

            const changeLocation = (locId) => {
                setCurrentLocation(locId);
                const locName = LOCATIONS.find(l => l.id === locId).name;
                setMessages(prev => [...prev, { id: Date.now(), sender: 'System', text: `You entered ${locName}.`, type: 'system' }]);
                setIsSidebarOpen(false);
                setLessonActive(false); setBattleActive(false); setLibraryActive(false);
            };

            if (!user) return <LoginScreen onJoin={(name, tribeId, avatar) => setUser({ name, tribe: TRIBES.find(t => t.id === tribeId), avatar })} />;
            const currentLocData = LOCATIONS.find(l => l.id === currentLocation);

            return (
                <div className="flex h-screen bg-transparent text-stone-100 font-sans overflow-hidden">
                    {activeCall && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-4">
                            {activeCall.partner.agentUrl ? (
                                <div className="relative w-full h-full max-w-4xl bg-white rounded-lg overflow-hidden flex flex-col shadow-2xl safe-top safe-bottom">
                                    <button onClick={() => setActiveCall(null)} className="absolute top-4 right-4 z-50 p-2 bg-red-600 text-white rounded-full shadow-lg"><Icons.X /></button>
                                    <iframe id={`JotFormIFrame-${activeCall.partner.id}`} src={activeCall.partner.agentUrl} allow="geolocation; microphone; camera; fullscreen" frameBorder="0" style={{ minWidth: '100%', height: '100%' }} scrolling="no" />
                                </div>
                            ) : (
                                <div className="w-full max-w-2xl bg-stone-800 rounded-2xl overflow-hidden shadow-2xl border border-stone-700 flex flex-col h-[600px] safe-top safe-bottom">
                                    <div className={`flex-1 relative flex items-center justify-center ${activeCall.partner.avatarColor} bg-opacity-20`}>
                                        <div className="relative z-10 flex flex-col items-center animate-bounce-slow">
                                            <img src={activeCall.partner.avatarImage} className="w-32 h-32 rounded-full border-4 border-white/20 shadow-2xl object-cover bg-stone-800" />
                                            <h2 className="mt-4 text-2xl font-bold text-white">{activeCall.partner.name}</h2>
                                            <p className="text-white/70 text-sm">{activeCall.partner.tribe}</p>
                                        </div>
                                        <div className="absolute bottom-8 left-8 right-8 bg-black/60 backdrop-blur-md p-4 rounded-xl text-center">
                                            <p className="text-white text-lg font-medium">"{messages[messages.length-1].sender === activeCall.partner.name ? messages[messages.length-1].text : '...'}"</p>
                                        </div>
                                    </div>
                                    <div className="bg-stone-900 p-6 flex justify-center gap-6">
                                        <button onClick={() => setActiveCall(null)} className="p-4 rounded-full bg-red-600 text-white"><Icons.PhoneOff size={24}/></button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    <div className={`fixed inset-y-0 left-0 w-64 bg-stone-800/90 backdrop-blur-md text-stone-100 transform transition-transform duration-300 z-30 md:relative md:translate-x-0 border-r border-stone-700 safe-top safe-bottom ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-stone-700 bg-stone-900/50">
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-teal-200 uppercase tracking-tighter">Jade Mountain</h1>
                        </div>
                        <div className="p-4 flex flex-col h-[calc(100%-80px)]">
                            <div className="flex items-center gap-3 p-3 bg-stone-700/50 rounded-lg mb-6 border border-stone-600">
                                <DragonAvatar tribe={user.tribe} custom={user.avatar} size="sm" />
                                <div><p className="font-bold text-sm">{user.name}</p></div>
                            </div>
                            <nav className="space-y-1 flex-1 overflow-y-auto">
                                <button onClick={() => { setActiveTab('winglet'); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded-md flex items-center gap-2 mb-4 ${activeTab === 'winglet' ? 'bg-emerald-900/50 text-emerald-200' : 'hover:bg-stone-700'}`}><Icons.Users size={16} /> Winglet Members</button>
                                {LOCATIONS.map(loc => (
                                    <button key={loc.id} onClick={() => changeLocation(loc.id)} className={`w-full text-left p-2 rounded-md flex items-center gap-2 ${currentLocation === loc.id ? 'bg-stone-700 text-white' : 'text-stone-400 hover:bg-stone-700'}`}><loc.icon size={16} />{loc.name}</button>
                                ))}
                            </nav>
                            <button onClick={handleLogout} className="mt-2 w-full p-2 text-stone-400 hover:text-red-400 flex items-center gap-2"><Icons.LogOut size={16} /> Logout</button>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col h-full relative">
                        <header className="h-16 bg-white/90 backdrop-blur border-b border-stone-200 flex items-center justify-between px-4 shadow-sm z-10 safe-top">
                            <div className="flex items-center gap-3 text-stone-800">
                                <button onClick={() => setIsSidebarOpen(true)} className="md:hidden"><Icons.Menu size={24} /></button>
                                <currentLocData.icon size={20} /><h2 className="font-bold">{currentLocData.name}</h2>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={triggerWingletChat} className="p-2 bg-emerald-100 text-emerald-700 rounded-lg flex items-center gap-2 text-sm font-bold shadow-sm" title="Listen in on Winglet Conversation"><Icons.Ear size={18} /> Listen In</button>
                                <button onClick={() => setActiveTab('chat')} className={`p-2 rounded-lg ${activeTab === 'chat' ? 'bg-stone-200 text-stone-800' : 'text-stone-400 hover:bg-stone-100'}`}><Icons.MessageCircle size={20} /></button>
                                <button onClick={() => setActiveTab('winglet')} className={`p-2 rounded-lg ${activeTab === 'winglet' ? 'bg-stone-200 text-stone-800' : 'text-stone-400 hover:bg-stone-100'}`}><Icons.Users size={20} /></button>
                            </div>
                        </header>

                        <div className={`flex-1 overflow-hidden relative ${currentLocData.bg} transition-colors duration-500`}>
                            {activeTab === 'chat' && (
                                <div className="h-full flex flex-col max-w-4xl mx-auto bg-white/85 backdrop-blur-sm shadow-xl border-x border-stone-200">
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                        {messages.map((msg) => (
                                            <div key={msg.id} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                {msg.type === 'npc' && (
                                                    <img src={msg.avatarImage || 'https://via.placeholder.com/32'} className="w-8 h-8 rounded-full flex-shrink-0 mr-2 object-cover shadow-sm bg-stone-200" />
                                                )}
                                                <div className={`max-w-[80%] rounded-2xl px-4 py-2 shadow-sm text-sm ${msg.type === 'user' ? 'bg-emerald-600 text-white rounded-br-none' : msg.type === 'system' ? 'bg-stone-200 text-stone-600 text-xs italic w-full text-center' : 'bg-white border border-stone-200 text-stone-800 rounded-bl-none'}`}>{msg.text}</div>
                                            </div>
                                        ))}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <div className="p-4 bg-white border-t border-stone-200 safe-bottom">
                                        <form onSubmit={handleSendMessage} className="flex gap-2">
                                            <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="Say something..." className="flex-1 px-4 py-2 border border-stone-300 rounded-full focus:ring-2 focus:ring-emerald-500 bg-stone-50 outline-none text-stone-800" />
                                            <button type="submit" className="p-2 bg-emerald-600 text-white rounded-full"><Icons.Send size={20} /></button>
                                        </form>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'winglet' && (
                                <div className="h-full overflow-y-auto p-6 max-w-3xl mx-auto safe-bottom">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {NPCS.map(npc => (
                                            <div key={npc.id} className="bg-white/90 p-4 rounded-xl flex items-center justify-between shadow-sm border border-stone-200 text-stone-800">
                                                <div className="flex items-center gap-4">
                                                    <img src={npc.avatarImage} className="w-12 h-12 rounded-full object-cover shadow border-2 border-stone-100" />
                                                    <div><h3 className="font-bold">{npc.name}</h3><p className="text-xs text-stone-500 uppercase">{npc.tribe}</p></div>
                                                </div>
                                                <button onClick={() => setActiveCall({ partner: npc })} className="p-2 bg-indigo-100 text-indigo-600 rounded-full"><Icons.PhoneCall size={18} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function LoginScreen({ onJoin }) {
            const [name, setName] = useState('');
            const [tribe, setTribe] = useState(TRIBES[0].id);
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-stone-900 to-emerald-950">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-stone-800">
                        <h1 className="text-3xl font-extrabold mb-2 text-emerald-800">Jade Mountain</h1>
                        <p className="text-stone-500 mb-8">Enrollment Office</p>
                        <form onSubmit={(e) => { e.preventDefault(); onJoin(name, tribe, { eyeColor: '#000000', accessory: 'none' }); }} className="space-y-4">
                            <div><label className="text-xs font-bold text-stone-400 uppercase">Dragon Name</label><input type="text" required value={name} onChange={e => setName(e.target.value)} className="w-full p-3 rounded-lg border border-stone-200 mt-1" placeholder="e.g. Moonwatcher" /></div>
                            <div><label className="text-xs font-bold text-stone-400 uppercase">Your Tribe</label>
                                <select value={tribe} onChange={e => setTribe(e.target.value)} className="w-full p-3 rounded-lg border border-stone-200 mt-1">
                                    {TRIBES.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                </select>
                            </div>
                            <button type="submit" className="w-full py-4 bg-emerald-600 text-white font-bold rounded-xl shadow-lg mt-4">Start Prophecy</button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JadeMountainAcademy />);
    </script>
</body>
</html>

